<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003"
         ToolsVersion="4.0">

  <PropertyGroup>
    <!-- 
    following properties are comming from .cmd:
      config: Release/Debug
      PackageVersion: version of the package, according to myget
      nuget: path to nuget.exe
    -->

    <!-- working directory of msbuild is root\build -->
    <BuildOut>$(MSBuildProjectDirectory)\..\build.out</BuildOut>
    <BuildOut452>$(BuildOut)\net452</BuildOut452>
    <BuildOutCore>$(BuildOut)\netCore</BuildOutCore>
  </PropertyGroup>

  <Target Name="main">
    <RemoveDir Directories="$(BuildOut)" />
    <MakeDir Directories="$(BuildOut)" />

    <Exec Command="dotnet restore ..\Sources\SqlDatabase.sln" />

    <MSBuild Projects="..\Sources\SqlDatabase.PowerShell\SqlDatabase.PowerShell.csproj"
             Properties="Configuration=$(config);OutDir=$(BuildOut452);TargetFramework=net452"/>

    <!--https://stackoverflow.com/questions/443188/msbuild-task-to-read-version-of-dll-->
    <GetAssemblyIdentity AssemblyFiles="$(BuildOut452)\SqlDatabase.exe">
      <Output TaskParameter="Assemblies"
              ItemName="AssemblyIdentities"/>
    </GetAssemblyIdentity>

    <!-- override PackageVersion by value from .exe -->
    <CreateProperty Value="%(AssemblyIdentities.Version)">
      <Output TaskParameter="Value"
              PropertyName="PackageVersion"/>
    </CreateProperty>

    <ReplaceTextInFile Filename="$(BuildOut452)\SqlDatabase.PowerShell.psd1"
                       MatchText="{{ModuleVersion}}"
                       ReplacementText="$(PackageVersion)" />

    <Exec Command="$(nuget) pack ..\Sources\SqlDatabase.Package\package.nuspec -NoPackageAnalysis -verbosity detailed -OutputDirectory $(BuildOut452) -Version $(PackageVersion) -p bin=$(BuildOut452)" />

    <Exec Command="dotnet pack ..\Sources\SqlDatabase\SqlDatabase.csproj -c Release -p:PackAsTool=true -p:TargetFrameworks=netcoreapp2.2 -p:PackageVersion=$(PackageVersion) -o $(BuildOutCore)" />
  </Target>

  <UsingTask TaskName="ReplaceTextInFile"
             TaskFactory="CodeTaskFactory"
             AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.v4.0.dll">
    <ParameterGroup>
      <Filename ParameterType="System.String"
                Required="true" />
      <MatchText ParameterType="System.String"
                 Required="true" />
      <ReplacementText ParameterType="System.String"
                       Required="true" />
    </ParameterGroup>
    <Task>
      <Reference Include="System.Core" />
      <Using Namespace="System" />
      <Using Namespace="System.IO" />
      <Using Namespace="System.Text" />
      <Code Type="Fragment"
            Language="cs">
        <![CDATA[
            var text = new StringBuilder();
            Encoding fileEncoding;

            using (var reader = new StreamReader(Filename))
            {
                text.Append(reader.ReadToEnd());
                fileEncoding = reader.CurrentEncoding;
            }

            text.Replace(MatchText, ReplacementText);
            File.WriteAllText(Filename, text.ToString(), fileEncoding);
          ]]>
      </Code>
    </Task>
  </UsingTask>
</Project>