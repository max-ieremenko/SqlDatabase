<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003"
         ToolsVersion="4.0">

  <PropertyGroup>
    <!-- 
    following properties are comming from .cmd:
      config: Release/Debug
      PackageVersion: version of the package, according to myget
      nuget: path to nuget.exe
    -->

    <!-- working directory of msbuild is root\build -->
    <BuildOut>$(MSBuildProjectDirectory)\..\build.out</BuildOut>
    <BuildOut452>$(BuildOut)\net452</BuildOut452>
  </PropertyGroup>

  <Target Name="main">
    <RemoveDir Directories="$(BuildOut)" />
    <MakeDir Directories="$(BuildOut)" />

    <Exec Command="dotnet restore ..\Sources\SqlDatabase.sln" />

    <MSBuild Projects="..\Sources\SqlDatabase.PowerShell\SqlDatabase.PowerShell.csproj"
             Properties="Configuration=$(config);OutDir=$(BuildOut452);TargetFramework=net452"/>

    <!--https://stackoverflow.com/questions/443188/msbuild-task-to-read-version-of-dll-->
    <GetAssemblyIdentity AssemblyFiles="$(BuildOut452)\SqlDatabase.exe">
      <Output TaskParameter="Assemblies"
              ItemName="AssemblyIdentities"/>
    </GetAssemblyIdentity>

    <GetRepositoryCommit>
      <Output TaskParameter="CommitId"
              PropertyName="RepositoryCommitId" />
    </GetRepositoryCommit>

    <TrimVersion Value="%(AssemblyIdentities.Version)">
      <Output TaskParameter="Version"
              PropertyName="PackageVersion" />
    </TrimVersion>

    <Message Text="PackageVersion: $(PackageVersion)" />
    <Message Text="RepositoryCommitId: $(RepositoryCommitId)" />

    <ReplaceTextInFile Filename="$(BuildOut452)\SqlDatabase.psd1"
                       MatchText="{{ModuleVersion}}"
                       ReplacementText="$(PackageVersion)" />

    <Exec Command="$(nuget) pack ..\Sources\SqlDatabase.Package\package.nuspec -NoPackageAnalysis -verbosity detailed -OutputDirectory $(BuildOut) -Version $(PackageVersion) -p RepositoryCommit=$(RepositoryCommitId) -p bin=$(BuildOut452)" />

    <Exec Command="dotnet pack ..\Sources\SqlDatabase\SqlDatabase.csproj -c Release -p:PackAsTool=true -p:TargetFrameworks=netcoreapp2.2 -p:PackageVersion=$(PackageVersion) -p:RepositoryCommit=$(RepositoryCommitId) -o $(BuildOut)" />

    <ZipDirectory SourceDirectory="$(BuildOut452)"
                  DestinationFile="$(BuildOut)\SqlDatabase.$(PackageVersion).zip" />
  </Target>

  <UsingTask TaskName="TrimVersion"
             TaskFactory="CodeTaskFactory"
             AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.v4.0.dll">
    <ParameterGroup>
      <Value ParameterType="System.String"
             Required="true" />
      <Version ParameterType="System.String"
               Output="true" />
    </ParameterGroup>
    <Task>
      <Using Namespace="System" />
      <Code Type="Fragment"
            Language="cs">
        <![CDATA[  
            Version = new Version(Value).ToString();
            if (Version.EndsWith(".0"))
            {
                Version = Version.Substring(0, Version.Length - 2);
            }
]]>
      </Code>
    </Task>
  </UsingTask>

  <UsingTask TaskName="ReplaceTextInFile"
             TaskFactory="CodeTaskFactory"
             AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.v4.0.dll">
    <ParameterGroup>
      <Filename ParameterType="System.String"
                Required="true" />
      <MatchText ParameterType="System.String"
                 Required="true" />
      <ReplacementText ParameterType="System.String"
                       Required="true" />
    </ParameterGroup>
    <Task>
      <Reference Include="System.Core" />
      <Using Namespace="System" />
      <Using Namespace="System.IO" />
      <Using Namespace="System.Text" />
      <Code Type="Fragment"
            Language="cs">
        <![CDATA[
            var text = new StringBuilder();
            Encoding fileEncoding;

            using (var reader = new StreamReader(Filename))
            {
                text.Append(reader.ReadToEnd());
                fileEncoding = reader.CurrentEncoding;
            }

            text.Replace(MatchText, ReplacementText);
            File.WriteAllText(Filename, text.ToString(), fileEncoding);
          ]]>
      </Code>
    </Task>
  </UsingTask>

  <UsingTask TaskName="GetRepositoryCommit"
             TaskFactory="CodeTaskFactory"
             AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.v4.0.dll">
    <ParameterGroup>
      <CommitId ParameterType="System.String"
                Output="true" />
    </ParameterGroup>
    <Task>
      <Reference Include="System.Runtime.Serialization" />
      <Reference Include="System.Xml" />
      <Using Namespace="System" />
      <Using Namespace="System.Net" />
      <Using Namespace="System.Runtime.Serialization.Json" />
      <Using Namespace="System.Xml" />
      <Code Type="Fragment"
            Language="cs">
        <![CDATA[
            var client = new WebClient();
            client.Headers.Add("User-Agent", "ThirdPartyLibraries");
            using (var stream = client.OpenRead("https://api.github.com/repos/max-ieremenko/SqlDatabase/commits/master"))
            using (var reader = JsonReaderWriterFactory.CreateJsonReader(stream, XmlDictionaryReaderQuotas.Max))
            {
                while (reader.Read())
                {
                    if (reader.NodeType == XmlNodeType.Element && reader.Depth == 1 && "sha".Equals(reader.Name, StringComparison.Ordinal))
                    {
                        CommitId = reader.ReadElementContentAsString("sha", string.Empty);
                        break;
                    }
                }
            }
        ]]>
      </Code>
    </Task>
  </UsingTask>
</Project>